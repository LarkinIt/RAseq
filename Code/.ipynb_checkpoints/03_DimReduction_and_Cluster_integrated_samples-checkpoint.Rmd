---
title: "Visualize Samples"
# author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Preprocessing-and-Filtering}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(formatR)
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  tidy.opts = list(width.cutoff = 70), tidy = TRUE,
  linewidth = 70
)
```

# Overview
Read in scRNA-seq data:

* **The goal is to visualize RA samples**  

The sections below outline:

1. Set wd and output directory, load data

# Load Libraries
```{r}
# Load required libraries
library(Seurat)
library(Matrix)
library(dplyr)
library(ggplot2)
```

# Set output dir and load seurat data
```{r}
seurat_f <- "/ix/djishnu/Aaron_F/RA/Results/EMATB8322/integrated_samples/integrated_seurat.rds"
# Set your data directory path
out_dir <- "/ix/djishnu/Aaron_F/RA/Results/EMATB8322/integrated_samples/figs"
dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
setwd(out_dir)

seurat_obj <- LoadSeuratRds(seurat_f)

```

```{r}
# Determine number of PCs to use in dimensionReduction and clustering:
pdf("PCA_elbow_plot.pdf")
# Generate elbow plot
ElbowPlot(seurat_obj, ndims = 30)
dev.off()
```

# Clustering and Dimensionality reduction (scaling and PCs already calculated)
```{r}
# Step 1: Run UMAP based on PCA embeddings using first 12 PCs (as specified in paper)
seurat_obj <- RunUMAP(seurat_obj, 
                      reduction = "pca", 
                      dims = 1:11,
                      verbose = TRUE)


```

# Clustering and Dimensionality reduction (scaling and PCs already calculated)
```{r}
# Step 2: Perform clustering
# Find neighbors using the first 12 PCs
seurat_obj <- FindNeighbors(seurat_obj, 
                            reduction = "pca", 
                            dims = 1:11)

# Find clusters
seurat_obj <- FindClusters(seurat_obj, 
                          resolution = 0.5)  # Adjust resolution as needed

```


# Add clinical meta information
```{r}
patient_info <- read.csv("/ix/djishnu/Aaron_F/RA/Data/EMATB8322/patient_info_das28.csv")

# Create a named vector for mapping batch to group
# This creates a lookup table: batch_name -> group_value
group_mapping <- setNames(patient_info$Group, patient_info$Sample_name)

# Add the group column to metadata by matching batch to Sample_name
seurat_obj@meta.data$group <- group_mapping[seurat_obj@meta.data$batch]

# Create a named vector for mapping batch to cohort
# This creates a lookup table: batch_name -> group_value
cohort_mapping <- setNames(patient_info$Cohort, patient_info$Sample_name)

# Add the group column to metadata by matching batch to Sample_name
seurat_obj@meta.data$cohort <- cohort_mapping[seurat_obj@meta.data$batch]

```

# SAVE object
```{r}
#### SAVE ####
saveRDS(seurat_obj, file = "../integrated_seurat_DimReduced_and_Clustered.rds")

```

# Visualize
```{r}
# Step 3: Visualize the results
# UMAP plot colored by clusters
pdf("cluster_umap.pdf")
p1 <- DimPlot(seurat_obj, 
              reduction = "umap", 
              group.by = "seurat_clusters",
              label = TRUE, 
              label.size = 4) +
  ggtitle("UMAP - Clusters (First 12 PCs)")

p2 <- DimPlot(seurat_obj, 
                reduction = "umap", 
                group.by = "group") +
    ggtitle("UMAP - Group")

p3 <- DimPlot(seurat_obj, 
                reduction = "umap", 
                group.by = "cohort") +
    ggtitle("UMAP - Cohort")

print(p1)
print(p2)
print(p3)
dev.off()
```

# Visualize features
```{r}
# Set to RNA assay for gene expression
DefaultAssay(seurat_obj) <- "RNA"

pdf("myeloid_features_umap.pdf")

# Page 1: Cluster plot
p1 <- DimPlot(seurat_obj, 
              reduction = "umap", 
              group.by = "seurat_clusters",
              label = TRUE, 
              label.size = 4) +
  ggtitle("UMAP - Clusters (First 12 PCs)")
print(p1)

# Pages 2-6: Individual gene plots (one per page)
genes <- c("CD14", "MARCO", "LYZ", "ITGAM", "FCGR1A")

for(gene in genes) {
  p <- FeaturePlot(seurat_obj,
                   features = gene,
                   reduction = "umap",
                   pt.size = 0.5,
                   order = TRUE) +
    ggtitle(paste("Expression of", gene))
  print(p)
}

dev.off()
```